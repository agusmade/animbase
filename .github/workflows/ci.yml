name: CI

on:
    push:
        branches: [main]
    pull_request:
        branches: [main]
    workflow_dispatch:

concurrency:
    group: ci-${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

permissions:
    contents: read

jobs:
    lint:
        runs-on: ubuntu-latest
        strategy:
            fail-fast: true
            matrix:
                node: [20]

        steps:
            - name: â¬‡ï¸ Checkout repo
              uses: actions/checkout@v3

            - name: ğŸ§¶ Setup Node & Yarn
              uses: actions/setup-node@v3
              with:
                  node-version: ${{ matrix.node }}
                  cache: 'yarn'
                  cache-dependency-path: yarn.lock

            - name: ğŸ“¦ Install dependencies
              run: yarn install --frozen-lockfile

            - name: ğŸ§¹ Lint source code
              run: yarn lint

    test:
        runs-on: ubuntu-latest
        strategy:
            fail-fast: true
            matrix:
                node: [18, 20]

        steps:
            - name: â¬‡ï¸ Checkout repo
              uses: actions/checkout@v3

            - name: ğŸ§¶ Setup Node & Yarn
              uses: actions/setup-node@v3
              with:
                  node-version: ${{ matrix.node }}
                  cache: 'yarn'
                  cache-dependency-path: yarn.lock

            - name: ğŸ“¦ Install dependencies
              run: yarn install --frozen-lockfile

            - name: ğŸ§ª Run tests
              run: yarn test:run

    coverage:
        runs-on: ubuntu-latest
        strategy:
            fail-fast: true
            matrix:
                node: [20]

        steps:
            - name: â¬‡ï¸ Checkout repo
              uses: actions/checkout@v3

            - name: ğŸ§¶ Setup Node & Yarn
              uses: actions/setup-node@v3
              with:
                  node-version: ${{ matrix.node }}
                  cache: 'yarn'
                  cache-dependency-path: yarn.lock

            - name: ğŸ“¦ Install dependencies
              run: yarn install --frozen-lockfile

            - name: ğŸ“Š Run coverage
              run: yarn test:cov

            - name: â¬†ï¸ Upload coverage artifact
              uses: actions/upload-artifact@v4
              with:
                  name: coverage
                  path: coverage

            - name: ğŸ“ˆ Upload coverage to Codecov
              uses: codecov/codecov-action@v4
              with:
                  files: coverage/coverage-final.json
                  flags: unittests
                  fail_ci_if_error: false
              env:
                  CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

    build:
        runs-on: ubuntu-latest
        strategy:
            fail-fast: true
            matrix:
                node: [20]

        steps:
            - name: â¬‡ï¸ Checkout repo
              uses: actions/checkout@v3

            - name: ğŸ§¶ Setup Node & Yarn
              uses: actions/setup-node@v3
              with:
                  node-version: ${{ matrix.node }}
                  cache: 'yarn'
                  cache-dependency-path: yarn.lock

            - name: ğŸ“¦ Install dependencies
              run: yarn install --frozen-lockfile

            - name: ğŸ“¦ Build (Rollup)
              run: yarn build
